name: Release Tensorlink

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Publish Tensorlink Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install poetry build twine

    - name: Install dependencies
      run: |
        poetry install --only main --no-interaction --no-ansi

    - name: Sync version from git tag
      run: |
        VERSION=${GITHUB_REF_NAME#v}
        poetry version "$VERSION"

    # Build Python Package
    - name: Build wheel + sdist
      run: |
        poetry build

    # Ensure build has not silently failed
    - name: Verify build artifacts
      run: |
        ls -lh dist

    # Upload to PyPI
    - name: Upload to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload --skip-existing dist/*

    # Build tensorlink-node binary
    - name: Build tensorlink node artifact
      run: |
        chmod +x tensorlink/bin/run-node.sh
        VERSION=${GITHUB_REF_NAME#v}
        mkdir -p release
        tar -czf release/tensorlink-node-v${VERSION}.tar.gz tensorlink/bin

    # Create GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/*
          release/*.tar.gz
        generate_release_notes: true
